version: 2.1
default: &default
  working_directory: /app
  docker:
    - image: philophilo/circleci-kube
      auth:
        username: $DOCKER_USERNAME
        password: $DOCKER_PASSWORD
      environment:
        DATABASE_USER: $DATABASE_USER
        DATABASE_PASSWORD: $DATABASE_PASSWORD
        DATABASE_NAME: $DATABASE_NAME
        DATABASE_PORT: $DATABASE_PORT
        SECRET_KEY: $SECRET_KEY
        EMAIL_HOST: $EMAIL_HOST
        EMAIL_PORT: $EMAIL_PORT
        EMAIL_HOST_USER: $EMAIL_HOST_USER
        EMAIL_HOST_PASSWORD: $EMAIL_HOST_PASSWORD

database: &database
  docker:
    - image: circleci/postgres:9.6.5-alpine-ram
      environment:
        POSTGRES_USER: $DATABASE_USER
        POSTGRES_DB: $DATABASE_NAME
        POSTGRES_PASSWORD: $DATABASE_PASSWORD

aws: &aws
  run:
    command: |
      mkdir -p ~/.aws
      echo "[default]" > ~/.aws/credentials
      echo "aws_access_key_id = ${AWS_SECRET_KEY}" >> ~/.aws/credentials
      echo "aws_secret_access_key = ${AWS_ACCESS_KEY}" >> ~/.aws/credentials
      echo "[default]" >> ~/.aws/config
      echo "region =${REGION}" >> ~/.aws/config

jobs:
  build:
    <<: *default
    <<: *database
    steps:
      - checkout
      - run:
          command: |
            pip install -r requirements.txt
            cd api/
            python manage.py test
